---
import LeadMagnetBase from './lead-magnets/LeadMagnetBase.astro';

export interface Props {
  formId?: string;
}

const { formId } = Astro.props;
---

<section class="visa-guide-fullwidth-section">
  <div class="container">
    <div class="visa-guide-content">
      <div class="visa-guide-form-container">
        <h2>Get Your Free Family Visa Research Guide</h2>
        <p class="visa-guide-description">The stress-free visa research cheat sheet for slow travel families. Never miss an important visa requirement again!</p>
        
        <div class="visa-guide-benefits">
          <p>âœ… Step-by-step visa research checklist</p>
          <p>âœ… Country-specific visa requirements database</p>
          <p>âœ… Family-specific visa considerations</p>
          <p>âœ… Common visa pitfalls and how to avoid them</p>
        </div>
        
        <form id="visa-guide-form" class="visa-guide-form">
          <div class="form-group">
            <input type="email" id="visa-email" name="email" placeholder="Your email address" required class="form-input">
            <!-- Honeypot field for spam protection -->
            <input type="text" name="website" style="position: absolute; left: -9999px;" tabindex="-1" autocomplete="off">
            <button type="submit" id="visa-submit" class="btn btn-primary">
              <span class="btn-text">Get Free Access</span>
              <span class="loading-spinner" style="display: none;"></span>
            </button>
          </div>
          <div class="form-message" style="display: none;"></div>
          <div class="form-privacy">
            <small>ðŸ”’ Your email is safe. Unsubscribe anytime.</small>
          </div>
        </form>
      </div>
    </div>
    <div class="visa-guide-image">
      <img src="https://images.unsplash.com/photo-1655722725332-9925c96dd627?q=80&w=1170&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D" alt="Family traveling with passports and travel documents" width="400" height="300" loading="lazy">
    </div>
  </div>
</section>

<style>
  .visa-guide-fullwidth-section {
    padding: 4rem 0;
    background: linear-gradient(135deg, var(--primary-light) 0%, var(--secondary-light) 100%);
  }

  .visa-guide-fullwidth-section .container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 4rem;
    align-items: center;
  }

  .visa-guide-content {
    display: flex;
    justify-content: center;
  }

  .visa-guide-form-container {
    width: 100%;
    max-width: 500px;
    background: transparent;
    border-radius: 12px;
    padding: 2.5rem;
  }

  .visa-guide-form-container h2 {
    color: var(--dark);
    margin-bottom: 1rem;
    font-size: 1.8rem;
    font-weight: 600;
  }

  .visa-guide-description {
    color: var(--dark);
    margin-bottom: 1.5rem;
    line-height: 1.6;
  }

  .visa-guide-benefits {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 1.5rem;
    margin: 1.5rem 0;
    box-sizing: border-box;
    width: 100%;
    border: none;
  }

  .visa-guide-benefits p {
    margin-bottom: 0.75rem;
    color: var(--dark);
    font-size: 1rem;
    line-height: 1.5;
  }

  .visa-guide-benefits p:last-child {
    margin-bottom: 0;
  }

  .visa-guide-form {
    margin-top: 1.5rem;
  }

  .visa-guide-form .form-group {
    display: flex;
    flex-direction: row;
    gap: 1rem;
    margin-bottom: 1rem;
    width: 100%;
  }

  .visa-guide-form .form-input {
    flex: 1;
    padding: 0.75rem 1rem;
    border: 1px solid #ddd;
    border-radius: 8px;
    font-size: 1rem;
    height: 2.75rem;
    box-sizing: border-box;
    background: white;
    color: var(--dark);
    margin: 0;
  }

  .visa-guide-form .form-input::placeholder {
    color: #6c757d;
  }

  .visa-guide-form .btn {
    flex-shrink: 0;
    height: 2.75rem;
    padding: 0 1.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    white-space: nowrap;
    box-sizing: border-box;
    margin: 0;
    min-width: fit-content;
  }

  .visa-guide-form .form-privacy {
    font-size: 0.8rem;
    color: rgba(255, 255, 255, 0.8);
  }

  .form-message {
    padding: 0.75rem;
    border-radius: 5px;
    margin-bottom: 1rem;
  }

  .form-message.success {
    background: rgba(76, 175, 80, 0.1);
    color: #2e7d32;
    border: 1px solid rgba(76, 175, 80, 0.2);
  }

  .form-message.error {
    background: rgba(244, 67, 54, 0.1);
    color: #d32f2f;
    border: 1px solid rgba(244, 67, 54, 0.2);
  }

  .form-input.error {
    border-color: #dc3545;
    box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
  }

  .loading-spinner {
    width: 16px;
    height: 16px;
    border: 2px solid #ffffff;
    border-top: 2px solid transparent;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-left: 8px;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  .visa-guide-image {
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .visa-guide-image img {
    width: 100%;
    height: auto;
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    max-width: 400px;
  }

  @media (max-width: 768px) {
    .visa-guide-fullwidth-section .container {
      grid-template-columns: 1fr;
      text-align: center;
      gap: 2rem;
    }
    
    .visa-guide-form-container {
      max-width: 100%;
    }
    
    .visa-guide-form .form-group {
      flex-direction: column;
    }
    
    .visa-guide-image img {
      max-width: 100%;
    }
  }
</style>

<script>
  // Enhanced Lead Magnet Form Handler for Visa Guide
  document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('visa-guide-form');
    
    if (form) {
      // Enhanced email validation function
      function validateEmail(email) {
        const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
        return emailRegex.test(email);
      }
      
      // Enhanced form validation
      function validateForm(email) {
        const errors = [];
        
        // Check if email is empty
        if (!email || email.trim() === '') {
          errors.push('Email address is required');
          return errors;
        }
        
        // Check email length
        if (email.length > 254) {
          errors.push('Email address is too long');
        }
        
        // Check email format
        if (!validateEmail(email)) {
          errors.push('Please enter a valid email address');
        }
        
        // Check for common spam patterns
        const spamPatterns = [
          /test@/i,
          /admin@/i,
          /noreply@/i,
          /no-reply@/i,
          /mailer-daemon@/i
        ];
        
        if (spamPatterns.some(pattern => pattern.test(email))) {
          errors.push('Please use a valid personal email address');
        }
        
        return errors;
      }
      
      // Rate limiting - prevent multiple submissions
      let isSubmitting = false;
      const submitCooldown = 5000; // 5 seconds
      
      form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // Prevent multiple submissions
        if (isSubmitting) {
          return;
        }
        
        const emailInput = document.getElementById('visa-email');
        const submitBtn = document.getElementById('visa-submit');
        const btnText = submitBtn.querySelector('.btn-text');
        const btnLoading = submitBtn.querySelector('.loading-spinner');
        const messageDiv = form.querySelector('.form-message');
        const honeypotField = form.querySelector('input[name="website"]');
        
        // Check honeypot field (if filled, it's likely spam)
        if (honeypotField.value.trim() !== '') {
          console.log('Honeypot field filled - likely spam');
          messageDiv.textContent = 'Thank you for your interest!';
          messageDiv.className = 'form-message success';
          messageDiv.style.display = 'block';
          return;
        }
        
        const email = emailInput.value.trim();
        
        // Enhanced client-side validation
        const validationErrors = validateForm(email);
        
        if (validationErrors.length > 0) {
          messageDiv.textContent = validationErrors[0]; // Show first error
          messageDiv.className = 'form-message error';
          messageDiv.style.display = 'block';
          
          // Add visual feedback to input
          emailInput.classList.add('error');
          emailInput.focus();
          
          // Remove error class after user starts typing
          emailInput.addEventListener('input', function() {
            emailInput.classList.remove('error');
            messageDiv.style.display = 'none';
          }, { once: true });
          
          return;
        }
        
        // Set submitting state
        isSubmitting = true;
        
        // Show loading state
        btnText.textContent = 'Sending...';
        btnLoading.style.display = 'inline-block';
        submitBtn.disabled = true;
        messageDiv.style.display = 'none';
        emailInput.classList.remove('error');
        
        try {
          const response = await fetch('/api/visa-guide-download', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 
              email: email,
              timestamp: new Date().toISOString(),
              userAgent: navigator.userAgent
            })
          });
          
          const data = await response.json();
          
          if (response.ok && data.success) {
            messageDiv.textContent = 'Perfect! Your free resource is on its way. Check your inbox!';
            messageDiv.className = 'form-message success';
            emailInput.value = ''; // Clear the form
            
            // Track successful lead magnet submission
            if (typeof trackLeadMagnet === 'function') {
              trackLeadMagnet('visa-guide-form', 'success');
            }
            
            // Redirect to thank you page
            setTimeout(() => {
              window.location.href = '/thank-you-visa-guide';
            }, 2000);
          } else {
            // Handle specific error cases
            let errorMessage = 'Something went wrong. Please try again.';
            
            if (response.status === 429) {
              errorMessage = 'Too many requests. Please wait a moment and try again.';
            } else if (response.status === 400) {
              errorMessage = data.message || 'Please check your email address and try again.';
            } else if (response.status === 422) {
              errorMessage = 'This email address is already subscribed.';
            } else if (data.message) {
              errorMessage = data.message;
            }
            
            messageDiv.textContent = errorMessage;
            messageDiv.className = 'form-message error';
          }
        } catch (error) {
          console.error('Form submission error:', error);
          
          let errorMessage = 'Network error. Please check your connection and try again.';
          
          if (error.name === 'TypeError' && error.message.includes('fetch')) {
            errorMessage = 'Unable to connect to server. Please try again later.';
          }
          
          messageDiv.textContent = errorMessage;
          messageDiv.className = 'form-message error';
        }
        
        // Reset button and show message
        btnText.textContent = 'Get Free Access';
        btnLoading.style.display = 'none';
        submitBtn.disabled = false;
        messageDiv.style.display = 'block';
        
        // Reset submitting state after cooldown
        setTimeout(() => {
          isSubmitting = false;
        }, submitCooldown);
      });
      
      // Real-time validation feedback
      emailInput.addEventListener('blur', function() {
        const email = this.value.trim();
        if (email && !validateEmail(email)) {
          this.classList.add('error');
        } else {
          this.classList.remove('error');
        }
      });
    }
  });
</script>
