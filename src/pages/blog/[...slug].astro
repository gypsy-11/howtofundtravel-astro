---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import BlogCategoryFilter from '../../components/BlogCategoryFilter.astro';

// Get the slug from the URL params
const { slug } = Astro.params;

// Fetch the post directly (SSR approach)
let post;
try {
  const posts = await getCollection('blog');
  post = posts.find(p => p.slug === slug && !p.data.draft);
  
  if (!post) {
    return Astro.redirect('/404');
  }
} catch (error) {
  console.error('Error fetching blog post:', error);
  return Astro.redirect('/404');
}

const { Content } = await post.render();
---

<BaseLayout 
  title={post.data.title}
  description={post.data.description}
  image={post.data.image}
  canonical={post.data.canonical}
  type="article"
  publishedTime={post.data.publishedDate.toISOString()}
  modifiedTime={post.data.updatedDate?.toISOString()}
>
  <article class="blog-post-content">
    <!-- Blog Post Hero Section -->
    <section class="blog-hero">
      <div class="container">
        <div class="blog-hero-content">
          <div class="blog-hero-text">
            <div class="blog-post-meta">
              <time datetime={post.data.publishedDate.toISOString()}>
                {post.data.publishedDate.toLocaleDateString('en-US', { 
                  year: 'numeric', 
                  month: 'long', 
                  day: 'numeric' 
                })}
              </time>
              <span class="read-time">15 min read</span>
            </div>
            <h1>{post.data.title}</h1>
            <div class="blog-hero-subtitle">
              <p><em>How to leverage your remote work position to fund your travel dreams - based on 4.5 years of living as a digital nomad family with a remote work income</em></p>
            </div>
            <div class="blog-post-categories">
              {post.data.category.map((cat) => (
                <a href={`/blog/category/${cat.toLowerCase().replace(/\s+/g, '-')}`} class="blog-post-category">
                  {cat}
                </a>
              ))}
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Category Filter Section -->
    <BlogCategoryFilter 
      currentCategory={post.data.category[0].toLowerCase().replace(/\s+/g, '-')}
      showAllButton={true}
     />

    <!-- Blog Post Body -->
    <div class="blog-post-body">
      <div class="container">
        <div class="blog-content">
          <Content  />
        </div>
        
        <!-- Blog Post Footer -->
        <div class="blog-post-footer">
          <div class="blog-footer-content">
            <div class="blog-tags">
              <h3>Tags:</h3>
              <div class="tag-list">
                {post.data.tags.map((tag) => (
                  <a href={`/blog/tag/${tag.toLowerCase().replace(/\s+/g, '-')}`} class="tag">{tag}</a>
                ))}
              </div>
            </div>
            
            <div class="blog-author">
              <h3>About the Author</h3>
              <p>Melissa and her family of six have been travelling the world as digital nomads since February 2020. She's funding her travels with her remote work job and working on adding multiple income streams with online businesses. She shares everything she learns in her Skool community, Vibe Nomads. It's a free community and we'd love to see you inside.</p>
              <a href="https://vibenomads.org" class="btn btn-primary author-cta">Join Vibe Nomads</a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </article>
</BaseLayout>

<script>
  import { trackTagClick, trackCategoryClick, trackVibeNomadsClick } from '../../utils/eventHandlers.js';
  
  document.addEventListener('DOMContentLoaded', function() {
    // Track tag clicks
    const tagLinks = document.querySelectorAll('.tag-list .tag');
    tagLinks.forEach(tag => {
      tag.addEventListener('click', function() {
        const tagName = this.textContent.trim();
        trackTagClick(tagName);
      });
    });
    
    // Track category clicks
    const categoryLinks = document.querySelectorAll('.blog-post-category');
    categoryLinks.forEach(category => {
      category.addEventListener('click', function() {
        const categoryName = this.textContent.trim();
        trackCategoryClick(categoryName);
      });
    });
    
    // Track Vibe Nomads community clicks
    const vibeNomadsLinks = document.querySelectorAll('a[href*="vibenomads.org"]');
    vibeNomadsLinks.forEach(link => {
      link.addEventListener('click', function() {
        trackVibeNomadsClick('blog_post_author');
      });
    });
  });
</script>
